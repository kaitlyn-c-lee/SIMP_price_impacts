results_placebo <- tibble(
Group= "Placebo Species",
Coefficient = placebo_impacts$wtd.est,
p = placebo_impacts$p.val,
High95 = placebo_impacts$avg.tau.high, # 95%
Low95 = placebo_impacts$avg.tau.low,
`2016 Quantity` = sum(post_quant$mtons_raw))
results <- rbind(results, results_placebo)
results
View(results)
placebo_year_imports <- imports_placebo_yrs %>% filter(species_group %in% simp_groups & species_group!="Shrimp" & species_group!="Abalone") %>% group_by(month_yr) %>% summarise(mtons_raw=sum(mtons_raw), real_dollars=sum(real_dollars))
placebo_year_imports <- placebo_year_imports %>% filter(month_yr>= "2007-01-01" & month_yr<"2017-01-01")
placebo_year_imports$dollars_per_mton <- (placebo_year_imports$real_dollars / placebo_year_imports$mtons_raw)
results_placebo_years <-  as_tibble(list())
placebo_yr_plots <- list()
for(k in as.character(unique(placebo_year_imports$month_yr))){
if(k >="2012-01-01" & k <"2017-01-01" & str_detect(k, "-01-01")){
start_date <- as.Date(k) %m-% years(5) # use 5 years to fit model
end_date <- as.Date(k) %m+% years(1) # look at impacts one year out
ts_start <- as.numeric(format(start_date,"%Y"))
data <- placebo_year_imports %>% filter(month_yr<end_date & month_yr>=start_date) %>% arrange(month_yr)
post_quant <- data %>% filter(month_yr >= as.Date(k) %m-% years(1) & month_yr<k) # Save off quantity in post-treatment period
data <- (ts(data$dollars_per_mton, frequency=12, start=c(ts_start,1)))
file_name <- paste("Supercomputer/Output/placeboyear_", format(as.Date(k),"%Y"),".csv", sep="")
input_dataframe <- read_csv(file_name)
# specify covariates
covars_placeboyrs <- covars %>% filter(month_yr<end_date & month_yr>=start_date)
xreg_vars_placeboyrs <- covars_placeboyrs %>% select(all_of(xreg_vars_list))
n<-length(data)
dates <- seq.Date(from = as.Date(start_date), by = "months", length.out = n)
start<-as.numeric(strftime(as.Date(dates[1], "%Y-%m-%d"), "%u"))
placebo_forecasts <- MakeForecasts(y = data,candidate.models=input_dataframe ,dates = dates, int.date = as.Date(k),xreg =xreg_vars_placeboyrs, nboot=10000)
placebo_impacts <- ImpactEstimates(y = data,point.fcast=placebo_forecasts$combined.point.fcast, simulations=placebo_forecasts$combined.simulations, placebo_forecasts$fitted.vals,dates = dates, int.date = as.Date(k),weights=post_quant$mtons_raw)
placebo_yr_plots[[k]] <- placebo_impacts[["forecast.plot"]] + ggtitle(format(as.Date(k),"%Y")) +theme(legend.position="none",plot.title = element_text(size=28,hjust = 0.5),
axis.text=element_text(size=20),
axis.title=element_text(size=22), strip.text.x = element_text(size = 10), legend.title=element_text(size=22),
legend.text=element_text(size=20)) +
labs(color="Time series", linetype="Placebo date") +
guides(linetype = guide_legend(override.aes = list(fill = NA)))
# save estimates to dataframe
plot <- tibble(
Group = paste("Placebo Year", format(as.Date(k),"%Y"), sep=" "),
Coefficient = placebo_impacts$wtd.est,
p = placebo_impacts$p.val,
High95 = placebo_impacts$avg.tau.high, # 95%
Low95 = placebo_impacts$avg.tau.low,
`2016 Quantity` = NA)
results_placebo_years <- rbind(results_placebo_years,plot)
candidate_models_temp <- placebo_forecasts$candidate_models %>% rename(Model=model, `Exogenous Variables`=xreg, `Weight`=w_i) %>% select(!c(delta_i, ic))
candidate_models_temp$Series <- paste("Placebo Year", format(as.Date(k),"%Y"), sep=" ")
candidate_models <- rbind(candidate_models, candidate_models_temp)
}
}
candidate_models <- list()
for(k in as.character(unique(placebo_year_imports$month_yr))){
if(k >="2012-01-01" & k <"2017-01-01" & str_detect(k, "-01-01")){
start_date <- as.Date(k) %m-% years(5) # use 5 years to fit model
end_date <- as.Date(k) %m+% years(1) # look at impacts one year out
ts_start <- as.numeric(format(start_date,"%Y"))
data <- placebo_year_imports %>% filter(month_yr<end_date & month_yr>=start_date) %>% arrange(month_yr)
post_quant <- data %>% filter(month_yr >= as.Date(k) %m-% years(1) & month_yr<k) # Save off quantity in post-treatment period
data <- (ts(data$dollars_per_mton, frequency=12, start=c(ts_start,1)))
file_name <- paste("Supercomputer/Output/placeboyear_", format(as.Date(k),"%Y"),".csv", sep="")
input_dataframe <- read_csv(file_name)
# specify covariates
covars_placeboyrs <- covars %>% filter(month_yr<end_date & month_yr>=start_date)
xreg_vars_placeboyrs <- covars_placeboyrs %>% select(all_of(xreg_vars_list))
n<-length(data)
dates <- seq.Date(from = as.Date(start_date), by = "months", length.out = n)
start<-as.numeric(strftime(as.Date(dates[1], "%Y-%m-%d"), "%u"))
placebo_forecasts <- MakeForecasts(y = data,candidate.models=input_dataframe ,dates = dates, int.date = as.Date(k),xreg =xreg_vars_placeboyrs, nboot=10000)
placebo_impacts <- ImpactEstimates(y = data,point.fcast=placebo_forecasts$combined.point.fcast, simulations=placebo_forecasts$combined.simulations, placebo_forecasts$fitted.vals,dates = dates, int.date = as.Date(k),weights=post_quant$mtons_raw)
placebo_yr_plots[[k]] <- placebo_impacts[["forecast.plot"]] + ggtitle(format(as.Date(k),"%Y")) +theme(legend.position="none",plot.title = element_text(size=28,hjust = 0.5),
axis.text=element_text(size=20),
axis.title=element_text(size=22), strip.text.x = element_text(size = 10), legend.title=element_text(size=22),
legend.text=element_text(size=20)) +
labs(color="Time series", linetype="Placebo date") +
guides(linetype = guide_legend(override.aes = list(fill = NA)))
# save estimates to dataframe
plot <- tibble(
Group = paste("Placebo Year", format(as.Date(k),"%Y"), sep=" "),
Coefficient = placebo_impacts$wtd.est,
p = placebo_impacts$p.val,
High95 = placebo_impacts$avg.tau.high, # 95%
Low95 = placebo_impacts$avg.tau.low,
`2016 Quantity` = NA)
results_placebo_years <- rbind(results_placebo_years,plot)
candidate_models_temp <- placebo_forecasts$candidate_models %>% rename(Model=model, `Exogenous Variables`=xreg, `Weight`=w_i) %>% select(!c(delta_i, ic))
candidate_models_temp$Series <- paste("Placebo Year", format(as.Date(k),"%Y"), sep=" ")
candidate_models <- rbind(candidate_models, candidate_models_temp)
}
}
View(results_placebo_years)
process_data <- imports %>% filter(species_group %in% simp_groups & species_group!="Shrimp" & species_group!="Abalone" & !is.na(process_group)) %>% group_by(month_yr, process_group) %>% summarise(mtons_raw=sum(mtons_raw), real_dollars=sum(real_dollars))
process_data$dollars_per_mton <- (process_data$real_dollars / process_data$mtons_raw)
quant <- process_data %>% filter(month_yr>="2016-01-01" & month_yr<"2017-01-01") %>% group_by(process_group, month_yr) %>% summarise(mtons_raw=sum(mtons_raw))
quant <- quant %>% arrange(desc(mtons_raw))
month_fig<- list()
plots <- list()
for(i in unique(process_data$process_group)){
data <- process_data %>% filter(process_group==i) %>% arrange(month_yr)
data <- (ts(data$dollars_per_mton, frequency=12, start=c(2012,1)))
post_quant <- quant %>% filter(process_group==i)
n<-length(data)
dates <- seq.Date(from = as.Date("2012-01-01"), by = "months", length.out = n)
start<-as.numeric(strftime(as.Date(dates[1], "%Y-%m-%d"), "%u"))
file_name <- paste("Supercomputer/Output/", i,".csv", sep="")
input_dataframe <- read_csv(file_name)
processing_forecasts <- MakeForecasts(y = data,candidate.models=input_dataframe ,dates = dates, int.date = int.date,xreg =xreg_vars, nboot=10000)
processing_impacts <- ImpactEstimates(y = data,point.fcast=processing_forecasts$combined.point.fcast, simulations=processing_forecasts$combined.simulations, fitted.vals=processing_forecasts$fitted.vals,dates = dates, int.date = int.date,weights=post_quant$mtons_raw)
# Calculate perc price change
print(processing_impacts$wtd.est / weighted.mean(processing_forecasts$combined.point.fcast, post_quant$mtons_raw))
# save parallel trends figures
plots[[i]] <- processing_impacts[["forecast.plot"]] + ggtitle(i) +scale_y_continuous(label=comma)+theme(legend.position="none",plot.title = element_text(size=28,hjust = 0.5),
axis.text=element_text(size=18),
axis.title=element_text(size=24), strip.text.x = element_text(size = 14), legend.title=element_text(size=20),
legend.text=element_text(size=18))
# save estimates to dataframe
plot <- tibble(
Group = i,
Coefficient = processing_impacts$wtd.est,
p = processing_impacts$p.val,
High95 = processing_impacts$avg.tau.high, # 95%
Low95 = processing_impacts$avg.tau.low,
`2016 Quantity` = sum(post_quant$mtons_raw))
results <- rbind(results,plot)
candidate_models_temp <- processing_forecasts$candidate_models %>% rename(Model=model, `Exogenous Variables`=xreg, `Weight`=w_i) %>% select(!c(delta_i, ic))
candidate_models_temp$Series <- i
candidate_models <- rbind(candidate_models, candidate_models_temp)
# monthly plot
temp_month_processing <- tibble(
month=rep(1:12),
Estimate=as.vector(processing_impacts$raw.diff),
High95 = processing_impacts$monthly_high,
Low95 = processing_impacts$monthly_low,
Group=i
)
month_fig[[i]] <- ggplot(temp_month_processing, aes(x=month, y=Estimate)) +
geom_point(size=10) +
#geom_errorbar(aes(ymin = Low90, ymax = High90), width = 0.75, linewidth=2) +
geom_errorbar(aes(ymin = Low95, ymax = High95), width = 0.75, linewidth=2) +
#geom_errorbar(aes(ymin = Low99, ymax = High99), width = 0.75, linewidth=2) +
geom_hline(yintercept = 0, color="red", linetype="dashed", linewidth=1) +
labs(x=" ", y=" ") +
theme_bw()+
scale_x_continuous(breaks=c(3,6,9,12), labels = c( "Mar", "June", "Sept", "Dec"))+
scale_y_continuous(label=comma)+
facet_wrap(~Group)+
theme(axis.text=element_text(size=52),
axis.title=element_text(size=42), legend.text=element_text(size=52), legend.title=element_text(size=52),strip.text.x = element_text(size = 42))
# monthly_impact_processing <- rbind(monthly_impact_processing, temp_month_processing)
}
View(results)
species_imports <- imports %>% filter(species_group %in% simp_groups & species_group!="Shrimp" & species_group!="Abalone" & species_group!="") %>% group_by(species_group, month_yr) %>% summarise(mtons_raw=sum(mtons_raw), real_dollars=sum(real_dollars))
species_imports$dollars_per_mton <- (species_imports$real_dollars / species_imports$mtons_raw)
# Remove any species with NA in the ts
species_imports <- species_imports %>% group_by(species_group) %>% filter(!any(is.na(dollars_per_mton))) %>% ungroup
quant <- species_imports %>% filter(month_yr>="2016-01-01" & month_yr<"2017-01-01") %>% group_by(species_group,month_yr) %>% summarise(mtons_raw=sum(mtons_raw))
quant <- quant %>% arrange(desc(mtons_raw))
plots <- list()
for(i in unique(quant$species_group)){
data <- species_imports %>% filter(species_group==i) %>% arrange(month_yr)
data <- (ts(data$dollars_per_mton, frequency=12, start=c(2012,1)))
post_quant <- quant %>% filter(species_group==i)
n<-length(data)
dates <- seq.Date(from = as.Date("2012-01-01"), by = "months", length.out = n)
start<-as.numeric(strftime(as.Date(dates[1], "%Y-%m-%d"), "%u"))
j <- str_replace_all(i, ':', '_')
file_name <- paste("Supercomputer/Output/", j,".csv", sep="")
input_dataframe <- read_csv(file_name)
fpi_forecasts <- MakeForecasts(y = data,candidate.models=input_dataframe ,dates = dates, int.date = int.date,xreg =xreg_vars, nboot=10000)
fpi_impacts <- ImpactEstimates(y = data,point.fcast=fpi_forecasts$combined.point.fcast, simulations=fpi_forecasts$combined.simulations, fitted.vals=fpi_forecasts$fitted.vals,dates = dates, int.date = int.date,weights=post_quant$mtons_raw)
# save parallel trends figures
plots[[i]] <- fpi_impacts[["forecast.plot"]] + ggtitle(i) +theme(legend.position="none",plot.title = element_text(size=30,hjust = 0.5),
axis.text=element_text(size=24),
axis.title=element_text(size=28), strip.text.x = element_text(size = 20), legend.title=element_text(size=20),
legend.text=element_text(size=18))
# save estimates to dataframe
plot <- tibble(
Group = i,
Coefficient = fpi_impacts$wtd.est,
p = fpi_impacts$p.val,
High95 = fpi_impacts$avg.tau.high, # 95%
Low95 = fpi_impacts$avg.tau.low,
`2016 Quantity` = sum(post_quant$mtons_raw))
results <- rbind(results,plot)
candidate_models_temp <- fpi_forecasts$candidate_models %>% rename(Model=model, `Exogenous Variables`=xreg, `Weight`=w_i) %>% select(!c(delta_i, ic))
candidate_models_temp$Series <- i
candidate_models <- rbind(candidate_models, candidate_models_temp)
}
View(results)
#######################################################################################################
###################################  Run Code for SIMP Impacts Paper ###################################
# 1) Load in import data and covariates
# 2) Create forecasts and estimate impacts
# 3) Output results tables to overleaf
# 4) Using only the minimum model
# 5) Dropping problematic codes in processing result
#######################################################################################################
# clear R environment
rm(list = ls())
# Set working directory and input/output folder names
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
# load packages
library(pacman)
p_load(tidyverse, ggpubr, dplyr, stringr, haven,
readxl, rjson, jtools, readr, writexl, haven,ggrepel,usethis,shiny,devtools,
tidybayes, DescTools, purrr,xtable,tseries,texreg, grid, blsAPI, lubridate,scales, fredr, stats,forecast, foreach, doParallel,qdapRegex,sf)
# Figure + table location
output_location <- '/Users/kaitlynmalakoff/Dropbox (ASU)/Apps/Overleaf/Blue Crab/'
#######################################################################################################
# 1) Load in import data and covariates
load("Supercomputer/imports.RData")
load("Supercomputer/covars.RData")
# specify covariates (contemporaneous)
covars_group <- covars %>% filter(month_yr>="2012-01-01" & month_yr<"2018-01-01") %>% arrange(month_yr)
xreg_vars <- covars_group %>% select(!c(month, year, month_yr))
xreg_vars <- sapply(xreg_vars, as.numeric) # convert to numeric
xreg_vars <- as.data.frame(xreg_vars)
xreg_vars_list <- colnames(xreg_vars)
# Subset data for placebo years
imports_placebo_yrs <- imports
imports <- imports %>% filter(month_yr>= "2012-01-01" & month_yr<"2018-01-01")
# Adding intervention
int.date <- as.Date("2017-01-01")
# specify arguments for auto arima
#arima_args <- c(max.p = 6,max.P=6,max.d = 6,max.D=6,max.q = 6,max.Q=6,seasonal = TRUE,stepwise = FALSE,allowdrift = TRUE,allowmean = TRUE, approximation=FALSE, max.order=24)
# list of simp species groups
simp_groups <- c("Abalone", "Crab: Blue", "Crab: King", "Shark", "Dolphinfish", "Groundfish: Cod", "Grouper", "Sea Cucumber",
"Shrimp", "Snapper", "Swordfish", "Crab: Other", "Tuna: Other", "Tuna: Albacore",
"Tuna: Bluefin", "Tuna: Bigeye", "Tuna: Skipjack", "Tuna: Yellowfin")
simp_adj_groups <- c("Other Molluscs",  "Other Aquatic Invertebrates", "Groundfish: Other",
"Other Crustaceans", "Whitefish")
#######################################################################################################
# 2) Create forecasts and estimate impacts
source("Code files/Functions_Forecasting.R")
source("Code files/Functions_ImpactEstimation.R")
#######################################################################################################
##################################  Main Price Analysis and Placebos ##################################
# 1) SARIMAX aggregate for all SIMP, drop shrimp and abalone
# 2) Placebo: non-SIMP species
# 3) Placebo years
# 4) Processing
# 5) NMFS species group
#######################################################################################################
source("Code files/Functions_ForecastingNoCombination.R")
#######################################################################################################
# 1) SARIMAX aggregate for all SIMP, drop shrimp and abalone
simp_species_imports <- imports %>% filter(species_group %in% simp_groups & species_group!="Shrimp" & species_group!="Abalone") %>% group_by(month_yr) %>% summarise(mtons_raw=sum(mtons_raw), real_dollars=sum(real_dollars))
quant_2017 <- simp_species_imports %>% filter(month_yr>="2017-01-01")
simp_species_imports$dollars_per_mton <- (simp_species_imports$real_dollars / simp_species_imports$mtons_raw)
post_quant <- simp_species_imports %>% filter(month_yr>="2016-01-01" & month_yr<"2017-01-01")
quant_2017 <- simp_species_imports %>% filter(month_yr>="2017-01-01")
data <- (ts(simp_species_imports$dollars_per_mton, frequency=12, start=c(2012,1)))
n<-length(data)
dates <- seq.Date(from = as.Date("2012-01-01"), by = "months", length.out = n)
start<-as.numeric(strftime(as.Date(dates[1], "%Y-%m-%d"), "%u"))
all_SIMP <- read_csv("Supercomputer/Output/all_SIMP.csv")
forecasts <- MakeForecasts(y = data,candidate.models=all_SIMP ,dates = dates, int.date = int.date,xreg =xreg_vars, nboot=10000)
impacts <- ImpactEstimates(y = data,point.fcast=forecasts$combined.point.fcast, simulations=forecasts$combined.simulations, fitted.vals=forecasts$fitted.vals,dates = dates, int.date = int.date,weights=post_quant$mtons_raw)
results_NC <- tibble(
Group= "SIMP Species",
Coefficient = impacts$wtd.est,
p = impacts$p.val,
High95 = impacts$avg.tau.high, # 95%
Low95 = impacts$avg.tau.low,
`2016 Quantity` = sum(post_quant$mtons_raw))
placebo_species <- imports %>% filter(!species_group %in% simp_groups & species_group!="Unidentified Species" & species_group!="Whitefish"
& !str_detect(species_group, "Shellfish") & !str_detect(species_group, "Groundfish") & !str_detect(species_group, "Crustaceans")
& !species_group %in% simp_adj_groups & !str_detect(species_group, "Crab") & species_group!="Rays Skates") %>% group_by(species_group) %>% summarise()
non_simp_species_imports <- imports %>% filter(species_group %in% placebo_species$species_group) %>% group_by(month_yr) %>% summarise(mtons_raw=sum(mtons_raw), real_dollars=sum(real_dollars))
print(paste(unlist(placebo_species), collapse =", "))
# print(xtable(placebo_species_save, type = "latex", caption = 'List of placebo species', label='table:placebo_species_list'), tabular.environment="longtable", floating=FALSE, include.rownames = FALSE, caption.placement = 'top', file = "/Users/kaitlynmalakoff/Dropbox (ASU)/Apps/Overleaf/Blue Crab/Tables/placebo_species_list.tex")
non_simp_species_imports$dollars_per_mton <- (non_simp_species_imports$real_dollars / non_simp_species_imports$mtons_raw)
post_quant <- non_simp_species_imports %>% filter(month_yr>="2016-01-01" & month_yr<"2017-01-01")
data <- (ts(non_simp_species_imports$dollars_per_mton, frequency=12, start=c(2012,1)))
n<-length(data)
dates <- seq.Date(from = as.Date("2012-01-01"), by = "months", length.out = n)
start<-as.numeric(strftime(as.Date(dates[1], "%Y-%m-%d"), "%u"))
placebospecies_models <- read_csv("Supercomputer/Output/placebospecies.csv")
placebo_forecasts <- MakeForecasts(y = data,candidate.models=placebospecies_models ,dates = dates, int.date = int.date,xreg =xreg_vars, nboot=10000)
placebo_impacts <- ImpactEstimates(y = data,point.fcast=placebo_forecasts$combined.point.fcast, simulations=placebo_forecasts$combined.simulations, fitted.vals=placebo_forecasts$fitted.vals,dates = dates, int.date = int.date,weights=post_quant$mtons_raw)
results_placebo <- tibble(
Group= "Placebo Species",
Coefficient = placebo_impacts$wtd.est,
p = placebo_impacts$p.val,
High95 = placebo_impacts$avg.tau.high, # 95%
Low95 = placebo_impacts$avg.tau.low,
`2016 Quantity` = sum(post_quant$mtons_raw))
results_NC <- rbind(results_NC, results_placebo)
#######################################################################################################
# 3) Placebo years
placebo_year_imports <- imports_placebo_yrs %>% filter(species_group %in% simp_groups & species_group!="Shrimp" & species_group!="Abalone") %>% group_by(month_yr) %>% summarise(mtons_raw=sum(mtons_raw), real_dollars=sum(real_dollars))
placebo_year_imports <- placebo_year_imports %>% filter(month_yr>= "2007-01-01" & month_yr<"2017-01-01")
placebo_year_imports$dollars_per_mton <- (placebo_year_imports$real_dollars / placebo_year_imports$mtons_raw)
results_placebo_years <-  as_tibble(list())
for(k in as.character(unique(placebo_year_imports$month_yr))){
if(k >="2012-01-01" & k <"2017-01-01" & str_detect(k, "-01-01")){
start_date <- as.Date(k) %m-% years(5) # use 5 years to fit model
end_date <- as.Date(k) %m+% years(1) # look at impacts one year out
ts_start <- as.numeric(format(start_date,"%Y"))
data <- placebo_year_imports %>% filter(month_yr<end_date & month_yr>=start_date) %>% arrange(month_yr)
post_quant <- data %>% filter(month_yr >= as.Date(k) %m-% years(1) & month_yr<k) # Save off quantity in post-treatment period
data <- (ts(data$dollars_per_mton, frequency=12, start=c(ts_start,1)))
file_name <- paste("Supercomputer/Output/placeboyear_", format(as.Date(k),"%Y"),".csv", sep="")
input_dataframe <- read_csv(file_name)
# specify covariates
covars_placeboyrs <- covars %>% filter(month_yr<end_date & month_yr>=start_date)
xreg_vars_placeboyrs <- covars_placeboyrs %>% select(all_of(xreg_vars_list))
n<-length(data)
dates <- seq.Date(from = as.Date(start_date), by = "months", length.out = n)
start<-as.numeric(strftime(as.Date(dates[1], "%Y-%m-%d"), "%u"))
placebo_forecasts <- MakeForecasts(y = data,candidate.models=input_dataframe ,dates = dates, int.date = as.Date(k),xreg =xreg_vars_placeboyrs, nboot=10000)
placebo_impacts <- ImpactEstimates(y = data,point.fcast=placebo_forecasts$combined.point.fcast, simulations=placebo_forecasts$combined.simulations, placebo_forecasts$fitted.vals,dates = dates, int.date = as.Date(k),weights=post_quant$mtons_raw)
# save estimates to dataframe
plot <- tibble(
Group = paste("Placebo Year", format(as.Date(k),"%Y"), sep=" "),
Coefficient = placebo_impacts$wtd.est,
p = placebo_impacts$p.val,
High95 = placebo_impacts$avg.tau.high, # 95%
Low95 = placebo_impacts$avg.tau.low,
`2016 Quantity` = NA)
results_placebo_years <- rbind(results_placebo_years,plot)
}
}
results_NC <- rbind(results_NC, results_placebo_years)
#######################################################################################################
# 4) Processing
process_data <- imports %>% filter(species_group %in% simp_groups & species_group!="Shrimp" & species_group!="Abalone" & !is.na(process_group)) %>% group_by(month_yr, process_group) %>% summarise(mtons_raw=sum(mtons_raw), real_dollars=sum(real_dollars))
process_data$dollars_per_mton <- (process_data$real_dollars / process_data$mtons_raw)
quant <- process_data %>% filter(month_yr>="2016-01-01" & month_yr<"2017-01-01") %>% group_by(process_group, month_yr) %>% summarise(mtons_raw=sum(mtons_raw))
quant <- quant %>% arrange(desc(mtons_raw))
for(i in unique(process_data$process_group)){
data <- process_data %>% filter(process_group==i) %>% arrange(month_yr)
data <- (ts(data$dollars_per_mton, frequency=12, start=c(2012,1)))
post_quant <- quant %>% filter(process_group==i)
n<-length(data)
dates <- seq.Date(from = as.Date("2012-01-01"), by = "months", length.out = n)
start<-as.numeric(strftime(as.Date(dates[1], "%Y-%m-%d"), "%u"))
file_name <- paste("Supercomputer/Output/", i,".csv", sep="")
input_dataframe <- read_csv(file_name)
processing_forecasts <- MakeForecasts(y = data,candidate.models=input_dataframe ,dates = dates, int.date = int.date,xreg =xreg_vars, nboot=10000)
processing_impacts <- ImpactEstimates(y = data,point.fcast=processing_forecasts$combined.point.fcast, simulations=processing_forecasts$combined.simulations, fitted.vals=processing_forecasts$fitted.vals,dates = dates, int.date = int.date,weights=post_quant$mtons_raw)
# save estimates to dataframe
plot <- tibble(
Group = i,
Coefficient = processing_impacts$wtd.est,
p = processing_impacts$p.val,
High95 = processing_impacts$avg.tau.high, # 95%
Low95 = processing_impacts$avg.tau.low,
`2016 Quantity` = sum(post_quant$mtons_raw))
results_NC <- rbind(results_NC,plot)
}
#######################################################################################################
# 5) NMFS species group
species_imports <- imports %>% filter(species_group %in% simp_groups & species_group!="Shrimp" & species_group!="Abalone" & species_group!="") %>% group_by(species_group, month_yr) %>% summarise(mtons_raw=sum(mtons_raw), real_dollars=sum(real_dollars))
species_imports$dollars_per_mton <- (species_imports$real_dollars / species_imports$mtons_raw)
# Remove any species with NA in the ts
species_imports <- species_imports %>% group_by(species_group) %>% filter(!any(is.na(dollars_per_mton))) %>% ungroup
quant <- species_imports %>% filter(month_yr>="2016-01-01" & month_yr<"2017-01-01") %>% group_by(species_group,month_yr) %>% summarise(mtons_raw=sum(mtons_raw))
quant <- quant %>% arrange(desc(mtons_raw))
arima_models_results_species <- as_tibble(list())
plots <- list()
for(i in unique(quant$species_group)){
data <- species_imports %>% filter(species_group==i) %>% arrange(month_yr)
data <- (ts(data$dollars_per_mton, frequency=12, start=c(2012,1)))
post_quant <- quant %>% filter(species_group==i)
n<-length(data)
dates <- seq.Date(from = as.Date("2012-01-01"), by = "months", length.out = n)
start<-as.numeric(strftime(as.Date(dates[1], "%Y-%m-%d"), "%u"))
j <- str_replace_all(i, ':', '_')
file_name <- paste("Supercomputer/Output/", j,".csv", sep="")
input_dataframe <- read_csv(file_name)
fpi_forecasts <- MakeForecasts(y = data,candidate.models=input_dataframe ,dates = dates, int.date = int.date,xreg =xreg_vars, nboot=10000)
fpi_impacts <- ImpactEstimates(y = data,point.fcast=fpi_forecasts$combined.point.fcast, simulations=fpi_forecasts$combined.simulations, fitted.vals=fpi_forecasts$fitted.vals,dates = dates, int.date = int.date,weights=post_quant$mtons_raw)
# save estimates to dataframe
plot <- tibble(
Group = i,
Coefficient = fpi_impacts$wtd.est,
p = fpi_impacts$p.val,
High95 = fpi_impacts$avg.tau.high, # 95%
Low95 = fpi_impacts$avg.tau.low,
`2016 Quantity` = sum(post_quant$mtons_raw))
results_NC <- rbind(results_NC,plot)
}
View(results_NC)
#######################################################################################################
###################################  Run Code for SIMP Impacts Paper ###################################
# 1) Load in import data and covariates
# 2) Create forecasts and estimate impacts
# 3) Output results tables to overleaf
# 4) Using only the minimum model
# 5) Dropping problematic codes in processing result
#######################################################################################################
# clear R environment
rm(list = ls())
# Set working directory and input/output folder names
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
# load packages
library(pacman)
p_load(tidyverse, ggpubr, dplyr, stringr, haven,
readxl, rjson, jtools, readr, writexl, haven,ggrepel,usethis,shiny,devtools,
tidybayes, DescTools, purrr,xtable,tseries,texreg, grid, blsAPI, lubridate,scales, fredr, stats,forecast, foreach, doParallel,qdapRegex,sf)
# Figure + table location
output_location <- '/Users/kaitlynmalakoff/Dropbox (ASU)/Apps/Overleaf/Blue Crab/'
#######################################################################################################
# 1) Load in import data and covariates
load("Supercomputer/imports.RData")
load("Supercomputer/covars.RData")
# specify covariates (contemporaneous)
covars_group <- covars %>% filter(month_yr>="2012-01-01" & month_yr<"2018-01-01") %>% arrange(month_yr)
xreg_vars <- covars_group %>% select(!c(month, year, month_yr))
xreg_vars <- sapply(xreg_vars, as.numeric) # convert to numeric
xreg_vars <- as.data.frame(xreg_vars)
xreg_vars_list <- colnames(xreg_vars)
# Subset data for placebo years
imports_placebo_yrs <- imports
imports <- imports %>% filter(month_yr>= "2012-01-01" & month_yr<"2018-01-01")
# Adding intervention
int.date <- as.Date("2017-01-01")
# specify arguments for auto arima
#arima_args <- c(max.p = 6,max.P=6,max.d = 6,max.D=6,max.q = 6,max.Q=6,seasonal = TRUE,stepwise = FALSE,allowdrift = TRUE,allowmean = TRUE, approximation=FALSE, max.order=24)
# list of simp species groups
simp_groups <- c("Abalone", "Crab: Blue", "Crab: King", "Shark", "Dolphinfish", "Groundfish: Cod", "Grouper", "Sea Cucumber",
"Shrimp", "Snapper", "Swordfish", "Crab: Other", "Tuna: Other", "Tuna: Albacore",
"Tuna: Bluefin", "Tuna: Bigeye", "Tuna: Skipjack", "Tuna: Yellowfin")
simp_adj_groups <- c("Other Molluscs",  "Other Aquatic Invertebrates", "Groundfish: Other",
"Other Crustaceans", "Whitefish")
#######################################################################################################
# 2) Create forecasts and estimate impacts
source("Code files/Functions_Forecasting.R")
source("Code files/Functions_ImpactEstimation.R")
#######################################################################################################
##################################  Robustness of Processing Result ##################################
# 1) Remove problematic codes
# 2) Processing robustness results
#######################################################################################################
# 1) Remove problematic codes
imports_robust <- imports %>% filter(ind_process_robust==0)
results <- list()
candidate_models <- list()
#######################################################################################################
# 2) Processing robustness results
process_data <- imports_robust %>% filter(species_group %in% simp_groups & species_group!="Shrimp" & species_group!="Abalone" & !is.na(process_group)) %>% group_by(month_yr, process_group) %>% summarise(mtons_raw=sum(mtons_raw), real_dollars=sum(real_dollars))
process_data$dollars_per_mton <- (process_data$real_dollars / process_data$mtons_raw)
quant <- process_data %>% filter(month_yr>="2016-01-01" & month_yr<"2017-01-01") %>% group_by(process_group, month_yr) %>% summarise(mtons_raw=sum(mtons_raw))
quant <- quant %>% arrange(desc(mtons_raw))
month_fig<- list()
plots <- list()
for(i in unique(process_data$process_group)){
data <- process_data %>% filter(process_group==i) %>% arrange(month_yr)
data <- (ts(data$dollars_per_mton, frequency=12, start=c(2012,1)))
post_quant <- quant %>% filter(process_group==i)
n<-length(data)
dates <- seq.Date(from = as.Date("2012-01-01"), by = "months", length.out = n)
start<-as.numeric(strftime(as.Date(dates[1], "%Y-%m-%d"), "%u"))
file_name <- paste("Supercomputer/Output/Robust_", i,".csv", sep="")
input_dataframe <- read_csv(file_name)
processing_forecasts <- MakeForecasts(y = data,candidate.models=input_dataframe ,dates = dates, int.date = int.date,xreg =xreg_vars, nboot=10000)
processing_impacts <- ImpactEstimates(y = data,point.fcast=processing_forecasts$combined.point.fcast, simulations=processing_forecasts$combined.simulations, fitted.vals=processing_forecasts$fitted.vals,dates = dates, int.date = int.date,weights=post_quant$mtons_raw)
# Calculate perc price change
print(processing_impacts$wtd.est / weighted.mean(processing_forecasts$combined.point.fcast, post_quant$mtons_raw))
# save parallel trends figures
plots[[i]] <- processing_impacts[["forecast.plot"]] + ggtitle(i) +scale_y_continuous(label=comma)+theme(legend.position="none",plot.title = element_text(size=28,hjust = 0.5),
axis.text=element_text(size=18),
axis.title=element_text(size=24), strip.text.x = element_text(size = 14), legend.title=element_text(size=20),
legend.text=element_text(size=18))
# save estimates to dataframe
plot <- tibble(
Group = i,
Coefficient = processing_impacts$wtd.est,
p = processing_impacts$p.val,
High95 = processing_impacts$avg.tau.high, # 95%
Low95 = processing_impacts$avg.tau.low,
`2016 Quantity` = sum(post_quant$mtons_raw))
results <- rbind(results,plot)
candidate_models_temp <- processing_forecasts$candidate_models %>% rename(Model=model, `Exogenous Variables`=xreg, `Weight`=w_i) %>% select(!c(delta_i, ic))
candidate_models_temp$Series <- i
candidate_models <- rbind(candidate_models, candidate_models_temp)
# monthly plot
temp_month_processing <- tibble(
month=rep(1:12),
Estimate=as.vector(processing_impacts$raw.diff),
High95 = processing_impacts$monthly_high,
Low95 = processing_impacts$monthly_low,
Group=i
)
month_fig[[i]] <- ggplot(temp_month_processing, aes(x=month, y=Estimate)) +
geom_point(size=10) +
#geom_errorbar(aes(ymin = Low90, ymax = High90), width = 0.75, linewidth=2) +
geom_errorbar(aes(ymin = Low95, ymax = High95), width = 0.75, linewidth=2) +
#geom_errorbar(aes(ymin = Low99, ymax = High99), width = 0.75, linewidth=2) +
geom_hline(yintercept = 0, color="red", linetype="dashed", linewidth=1) +
labs(x=" ", y=" ") +
theme_bw()+
scale_x_continuous(breaks=c(3,6,9,12), labels = c( "Mar", "June", "Sept", "Dec"))+
scale_y_continuous(label=comma)+
facet_wrap(~Group)+
theme(axis.text=element_text(size=52),
axis.title=element_text(size=40), legend.text=element_text(size=52), legend.title=element_text(size=52),strip.text.x = element_text(size = 42))
# monthly_impact_processing <- rbind(monthly_impact_processing, temp_month_processing)
}
View(results)
# save parallel trends figure
parallel_trends <- ggarrange(plotlist=plots, common.legend = TRUE, legend="bottom")
parallel_trends <- annotate_figure(parallel_trends, left = textGrob("2019 USD/ton Imported", rot = 90, vjust = 1, gp = gpar(cex = 2)),
bottom = textGrob("Date", vjust = -3.5, gp = gpar(cex = 2)))
ggsave(filename=paste(output_location, 'Figures/ModelAvgResults/processing_robust.png', sep=''), plot=parallel_trends, width = 15, height = 5, dpi = 200)
by_months <- ggarrange(plotlist=month_fig)
by_months <- annotate_figure(by_months, left = textGrob("Observed - Forecast (2019 USD/tonne)", rot = 90, vjust = 1, gp = gpar(cex = 3.25)),
bottom = textGrob("Date", vjust = -.5, gp = gpar(cex = 3.5)))
ggsave(filename=paste(output_location, 'Figures/ModelAvgResults/by_month_processing_robust.png', sep=''),plot=by_months, width = 25, height = 10, dpi = 200)
